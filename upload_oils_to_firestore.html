<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload olej≈Ø do Firestore</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .progress { 
            margin: 20px 0; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover { background: #45a049; }
        .button:disabled { background: #cccccc; cursor: not-allowed; }
        .log { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            max-height: 300px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <h1>üßº Upload olej≈Ø do Firestore</h1>
    
    <div class="progress">
        <p><strong>Status:</strong> <span id="status">P≈ôipraven k nahr√°n√≠</span></p>
        <p><strong>Pr≈Øbƒõh:</strong> <span id="progress">0/0</span></p>
    </div>
    
    <button id="uploadBtn" class="button">Nahr√°t oleje do Firestore</button>
    <button id="clearBtn" class="button" style="background: #f44336;">Vymazat v≈°echny oleje</button>
    
    <div id="log" class="log"></div>

    <script>
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyCNmpIv_emy31E4zrN_er-dw1hNk4YTJls",
            authDomain: "soap-calc-plus-1753694585.firebaseapp.com",
            projectId: "soap-calc-plus-1753694585",
            storageBucket: "soap-calc-plus-1753694585.firebasestorage.app",
            messagingSenderId: "851993744585",
            appId: "1:851993744585:web:6d156d5933a21a485ce918"
        };

        // Inicializace Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elementy
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');
        const logEl = document.getElementById('log');

        // Funkce pro logov√°n√≠
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // Funkce pro p≈ôid√°n√≠ jednoho oleje
        async function addOil(oil, index, total) {
            try {
                // Konverze struktury dat na spr√°vn√Ω form√°t
                const oilData = {
                    name: oil.name,
                    scientific_name: oil.scientific_name || null,
                    ins: oil.sap_ins_values?.ins || oil.ins || 0,
                    iodine: oil.oil_qualities?.iodine || oil.iodine || 0,
                    sap_koh: oil.sap_ins_values?.koh_sap || oil.sap_koh || 0,
                    sap_naoh: oil.sap_ins_values?.naoh_sap || oil.sap_naoh || 0,
                    properties: {
                        bubbly: oil.oil_qualities?.bubbly || oil.properties?.bubbly || 0,
                        creamy: oil.oil_qualities?.creamy || oil.properties?.creamy || 0,
                        hardness: oil.oil_qualities?.hardness || oil.properties?.hardness || 0,
                        cleansing: oil.oil_qualities?.cleansing || oil.properties?.cleansing || 0,
                        conditioning: oil.oil_qualities?.condition || oil.properties?.conditioning || 0,
                        long_life: oil.oil_qualities?.long_life || oil.properties?.long_life || 0
                    },
                    fatty_acids: {
                        oleic: oil.fatty_acids?.oleic || 0,
                        lauric: oil.fatty_acids?.lauric || 0,
                        stearic: oil.fatty_acids?.stearic || 0,
                        linoleic: oil.fatty_acids?.linoleic || 0,
                        myristic: oil.fatty_acids?.myristic || 0,
                        palmitic: oil.fatty_acids?.palmitic || 0,
                        linolenic: oil.fatty_acids?.linolenic || 0,
                        ricinoleic: oil.fatty_acids?.ricinoleic || 0
                    },
                    fatty_acid_types: {
                        saturated: oil.fatty_acid_types?.saturated || 0,
                        mono_unsaturated: oil.fatty_acid_types?.mono_unsaturated || 0,
                        poly_unsaturated: oil.fatty_acid_types?.poly_unsaturated || 0
                    },
                    url: oil.url || null,
                    extracted_at: oil.extracted_at || null,
                    createdAt: firebase.firestore.Timestamp.now(),
                    source: oil.source || 'lyecalc_crawl'
                };

                const docRef = await db.collection('oils').add(oilData);
                log(`‚úÖ Olej "${oil.name}" p≈ôid√°n s ID: ${docRef.id}`);
                progressEl.textContent = `${index + 1}/${total}`;
                return true;
            } catch (error) {
                log(`‚ùå Chyba p≈ôi p≈ôid√°n√≠ oleje "${oil.name}": ${error.message}`);
                return false;
            }
        }

        // Hlavn√≠ funkce pro nahr√°n√≠ v≈°ech olej≈Ø
        async function uploadAllOils() {
            try {
                uploadBtn.disabled = true;
                statusEl.textContent = "Naƒç√≠t√°n√≠ dat...";
                log("üöÄ Zaƒç√≠n√°m nahr√°v√°n√≠ olej≈Ø do Firestore");

                // Naƒçten√≠ kompletn√≠ch dat z complete_oils_data.json
                let allOilsData = [];
                
                try {
                    const response = await fetch('complete_oils_data.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.oils && Array.isArray(data.oils)) {
                            allOilsData = data.oils;
                            log(`üìÅ Naƒçten soubor complete_oils_data.json - ${data.oils.length} olej≈Ø`);
                            log(`üìä Celkov√° √∫spƒõ≈°nost crawlu: ${data.success_rate}`);
                        } else {
                            throw new Error("Neplatn√° struktura dat v complete_oils_data.json");
                        }
                    } else {
                        throw new Error(`HTTP chyba ${response.status} p≈ôi naƒç√≠t√°n√≠ complete_oils_data.json`);
                    }
                } catch (error) {
                    log(`‚ùå Nepoda≈ôilo se naƒç√≠st complete_oils_data.json: ${error.message}`);
                    
                    // Fallback na star≈°√≠ soubory
                    log(`üîÑ Zkou≈°√≠m naƒç√≠st star≈°√≠ soubory jako fallback...`);
                    const filesToLoad = [
                        'lyecalc_oils_batch1.json',
                        'lyecalc_oils_batch2.json', 
                        'lyecalc_oils_sample.json'
                    ];

                    for (const fileName of filesToLoad) {
                        try {
                            const response = await fetch(fileName);
                            if (response.ok) {
                                const data = await response.json();
                                if (data.oils && Array.isArray(data.oils)) {
                                    allOilsData.push(...data.oils);
                                    log(`üìÅ Naƒçten fallback soubor ${fileName} - ${data.oils.length} olej≈Ø`);
                                }
                            }
                        } catch (error) {
                            log(`‚ö†Ô∏è Nepoda≈ôilo se naƒç√≠st fallback ${fileName}: ${error.message}`);
                        }
                    }
                }

                if (allOilsData.length === 0) {
                    throw new Error("Nenalezena ≈æ√°dn√° data o olej√≠ch");
                }

                // Odstranƒõn√≠ duplicitn√≠ch olej≈Ø (podle n√°zvu)
                const uniqueOils = [];
                const seenNames = new Set();
                
                for (const oil of allOilsData) {
                    if (oil.name && !seenNames.has(oil.name)) {
                        seenNames.add(oil.name);
                        uniqueOils.push(oil);
                    }
                }

                log(`üìä Celkem nalezeno ${allOilsData.length} olej≈Ø, ${uniqueOils.length} unik√°tn√≠ch`);
                statusEl.textContent = "Nahr√°v√°m oleje...";
                progressEl.textContent = `0/${uniqueOils.length}`;

                // Nahr√°n√≠ olej≈Ø po jednom
                let successCount = 0;
                for (let i = 0; i < uniqueOils.length; i++) {
                    const success = await addOil(uniqueOils[i], i, uniqueOils.length);
                    if (success) successCount++;
                    
                    // Mal√° pauza aby se nestresovala datab√°ze
                    if (i % 10 === 0 && i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                statusEl.textContent = "Hotovo!";
                log(`üéâ Nahr√°v√°n√≠ dokonƒçeno! √öspƒõ≈°nƒõ nahr√°no ${successCount}/${uniqueOils.length} olej≈Ø`);

            } catch (error) {
                statusEl.textContent = "Chyba!";
                log(`‚ùå Kritick√° chyba: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // Funkce pro vymaz√°n√≠ v≈°ech olej≈Ø
        async function clearAllOils() {
            if (!confirm("Opravdu chcete vymazat V≈†ECHNY oleje z datab√°ze? Tuto akci nelze vr√°tit zpƒõt!")) {
                return;
            }

            try {
                clearBtn.disabled = true;
                statusEl.textContent = "Ma≈æu oleje...";
                log("üóëÔ∏è Zaƒç√≠n√°m maz√°n√≠ v≈°ech olej≈Ø");

                const snapshot = await db.collection('oils').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                
                statusEl.textContent = "Oleje vymaz√°ny";
                log(`‚úÖ Vymaz√°no ${snapshot.docs.length} olej≈Ø`);
                
            } catch (error) {
                statusEl.textContent = "Chyba p≈ôi maz√°n√≠!";
                log(`‚ùå Chyba p≈ôi maz√°n√≠: ${error.message}`);
            } finally {
                clearBtn.disabled = false;
            }
        }

        // Automatick√© anonymn√≠ p≈ôihl√°≈°en√≠
        auth.signInAnonymously().then(() => {
            log("üîê Anonymnƒõ p≈ôihl√°≈°en do Firebase");
        }).catch(error => {
            log(`‚ùå Chyba p≈ôi p≈ôihl√°≈°en√≠: ${error.message}`);
        });

        // Event listenery
        uploadBtn.addEventListener('click', uploadAllOils);
        clearBtn.addEventListener('click', clearAllOils);

        log("‚úÖ Aplikace p≈ôipravena k pou≈æit√≠");
    </script>
</body>
</html>
